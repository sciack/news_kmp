# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
      - "*"

permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

jobs:
  deploy_android:
    env:
      MIXDRINKS_MOBILE_APP_VERSION_NAME: ${{ needs.prepare_deploy.outputs.output_write_mix_drinks_mobile_version_name }}
      MIXDRINKS_MOBILE_APP_VERSION_CODE: ${{ needs.prepare_deploy.outputs.output_write_mix_drinks_mobile_version_code }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: "Setup Gradle"
        uses: gradle/gradle-build-action@v2
      - name: "Build retrieve the version"
        run: |
          ./gradlew versionEnv 
          # export the variable in the file as pipeline env
          cat version.env >> "$GITHUB_ENV"
      - name: "Build bundle release"
        run: ./gradlew android:bundleRelease
      - name: "Credentials"
        run: |
          echo ${{ secrets.KNEWS_ACCOUNT_JSON_KEY}} > google_account_key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$PWD/google_account_key.json" >> "$GITHUB_ENV"
      - name: "Push release"
        run: ./gradlew assembleRelease appDistributionUploadRelease